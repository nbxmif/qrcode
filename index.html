<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">QR Code Generator</h1>

    <!-- Input Section -->
    <div class="mb-4">
      <input
        id="qrInput"
        type="text"
        placeholder="Masukkan teks atau URL (misal: https://google.com atau data TLV)"
        class="w-full p-3 border border-gray-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 ease-in-out"
        aria-label="Input untuk QR Code"
      />
      <button
        id="generateQrBtn"
        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
      >
        Hasilkan QR Code
      </button>
    </div>

    <!-- QR Code Display Section -->
    <div id="qrCodeContainer" class="mt-8 flex flex-col items-center justify-center">
      <div id="qrLoadingIndicator" class="hidden animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-green-200 border-t-green-600 mb-4" role="status" aria-label="Loading QR Code">
        <span class="sr-only">Memuat...</span>
      </div>
      <img id="qrCodeImage" src="" alt="Kode QR yang dihasilkan" class="hidden mx-auto w-56 h-56 rounded-lg border border-gray-200 p-1" />
      <p id="placeholderText" class="text-gray-500 mt-4 text-base">QR Code akan muncul di sini</p>
    </div>

    <!-- Download Options Section -->
    <div id="downloadOptions" class="mt-6 hidden flex flex-col items-center">
      <div class="mb-4 w-full">
        <label for="fileTypeSelect" class="block text-gray-700 text-sm font-medium mb-2">Pilih Jenis File:</label>
        <select id="fileTypeSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="png">PNG</option>
          <option value="jpeg">JPEG</option>
          <option value="gif">GIF</option>
          <option value="svg">SVG</option>
        </select>
      </div>
      <button
        id="downloadQrBtn"
        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Unduh QR Code
      </button>
    </div>

    <!-- Parsed Content Section -->
    <div id="parsedContentContainer" class="mt-8 hidden text-left bg-gray-50 p-6 rounded-xl border border-gray-200">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Detail Konten (TLV format):</h2>
      <div id="parsedContentList" class="text-sm text-gray-700 overflow-y-auto max-h-80 pr-2">
        <!-- Parsed content will be injected here -->
      </div>
    </div>

    <!-- Message Box for alerts -->
    <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
        <p id="messageBoxText" class="text-lg font-medium text-gray-800 mb-4"></p>
        <button id="messageBoxCloseBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out">Tutup</button>
      </div>
    </div>

  </div>

  <script>
    // Get references to DOM elements
    const qrInput = document.getElementById('qrInput');
    const generateQrBtn = document.getElementById('generateQrBtn');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const placeholderText = document.getElementById('placeholderText');
    const qrLoadingIndicator = document.getElementById('qrLoadingIndicator');
    const parsedContentContainer = document.getElementById('parsedContentContainer');
    const parsedContentList = document.getElementById('parsedContentList');
    const messageBox = document.getElementById('messageBox');
    const messageBoxText = document.getElementById('messageBoxText');
    const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');
    const downloadOptions = document.getElementById('downloadOptions'); // New
    const fileTypeSelect = document.getElementById('fileTypeSelect');   // New
    const downloadQrBtn = document.getElementById('downloadQrBtn');     // New

    // Define descriptions for common EMVCo/QRIS TLV tags
    const tagDescriptions = {
      '00': 'Payload Format Indicator',
      '01': 'Point of Initiation Method',
      '02': 'Visa Credit', // Example for Merchant Account Information (MAI)
      '03': 'Mastercard Credit', // Example for MAI
      '04': 'EMVCo Reserved', // Example for MAI
      '05': 'QRIS Merchant Criteria', // Example for MAI
      '06': 'QRIS Merchant ID', // Example for MAI
      '07': 'QRIS Terminal ID', // Example for MAI
      '08': 'QRIS Merchant Name', // Example for MAI
      '09': 'QRIS City', // Example for MAI
      '10': 'QRIS Postal Code', // Example for MAI
      '11': 'QRIS Country', // Example for MAI
      '12': 'QRIS Transaction Type', // Example for MAI
      '13': 'QRIS Reference Label', // Example for MAI
      '14': 'QRIS Consumer ID', // Example for MAI
      '15': 'QRIS Bill Number', // Example for MAI
      '16': 'QRIS Mobile Number', // Example for MAI
      '17': 'QRIS Store Label', // Example for MAI
      '18': 'QRIS Loyalty Number', // Example for MAI
      '19': 'QRIS Customer Label', // Example for MAI
      '20': 'QRIS Purpose of Transaction', // Example for MAI
      '21': 'QRIS Additional Consumer Data', // Example for MAI
      '22': 'QRIS Payment Instrument Type', // Example for MAI
      '23': 'QRIS Payment Instrument ID', // Example for MAI
      '24': 'QRIS Payment Instrument Expiry', // Example for MAI
      '25': 'QRIS Payment Instrument Holder Name', // Example for MAI
      '26': 'Merchant Account Information (Template)',
      '51': 'QRIS Merchant Information (Template)',
      '52': 'Merchant Category Code',
      '53': 'Currency Code (ISO 4217)',
      '54': 'Transaction Amount',
      '55': 'Tip or Convenience Indicator',
      '56': 'Value of Convenience Fee Fixed',
      '57': 'Value of Convenience Fee Percentage',
      '58': 'Country Code (ISO 3166-1 alpha-2)',
      '59': 'Merchant Name',
      '60': 'Merchant City',
      '61': 'Postal Code',
      '62': 'Additional Data Field (Template)',
      '63': 'CRC (Cyclic Redundancy Check)',
      '64': 'Merchant Information Language (Template)',
      '65': 'RFU for EMVCo', // Reserved for Future Use
      '66': 'RFU for EMVCo',
      '67': 'RFU for EMVCo',
      '68': 'RFU for EMVCo',
      '69': 'RFU for EMVCo',
      '70': 'RFU for EMVCo',
      '71': 'RFU for EMVCo',
      '72': 'RFU for EMVCo',
      '73': 'RFU for EMVCo',
      '74': 'RFU for EMVCo',
      '75': 'RFU for EMVCo',
      '76': 'RFU for EMVCo',
      '77': 'RFU for EMVCo',
      '78': 'RFU for EMVCo',
      '79': 'RFU for EMVCo',
      '80': 'RFU for EMVCo',
      '81': 'RFU for EMVCo',
      '82': 'RFU for EMVCo',
      '83': 'RFU for EMVCo',
      '84': 'RFU for EMVCo',
      '85': 'Merchant Information - Proprietary',
      '99': 'Unreserved Templates',
    };


    /**
     * Shows a custom message box instead of alert().
     * @param {string} message - The message to display.
     */
    function showMessageBox(message) {
      messageBoxText.textContent = message;
      messageBox.classList.remove('hidden');
    }

    // Close button for the message box
    messageBoxCloseBtn.addEventListener('click', () => {
      messageBox.classList.add('hidden');
    });

    /**
     * Parses a TLV (Tag-Length-Value) string recursively.
     * @param {string} tlvString - The TLV string to parse.
     * @returns {Array<Object>} An array of parsed TLV objects.
     */
    function parseTLV(tlvString) {
      const result = [];
      let i = 0;
      while (i + 4 <= tlvString.length) {
        const tag = tlvString.slice(i, i + 2);
        const lengthStr = tlvString.slice(i + 2, i + 4);
        const len = parseInt(lengthStr, 10);

        // Basic validation for length and remaining string
        if (isNaN(len) || len < 0 || (i + 4 + len) > tlvString.length) {
          console.error(`Error parsing TLV: Invalid length or string truncated at index ${i}. Tag: ${tag}, Length String: ${lengthStr}`);
          // Attempt to recover by skipping this segment, or stop parsing
          showMessageBox(`Error parsing TLV: Invalid length or malformed data at tag ${tag}. Parsing stopped.`);
          break;
        }

        const value = tlvString.slice(i + 4, i + 4 + len);
        i += 4 + len;

        const description = tagDescriptions[tag] || 'Tidak diketahui';
        let children = [];

        // Recursively parse known template tags
        if (['26', '51', '62', '64', '85', '99'].includes(tag)) {
          children = parseTLV(value);
        }

        result.push({ tag, length: len, value, description, children });
      }
      return result;
    }

    /**
     * Displays the parsed TLV content in a structured way.
     * @param {Array<Object>} data - The array of parsed TLV objects.
     * @param {HTMLElement} parentElement - The DOM element to append the content to.
     * @param {number} level - The current nesting level for indentation.
     */
    function displayParsedContent(data, parentElement, level = 0) {
      // Clear previous content if it's the top level
      if (level === 0) {
        parentElement.innerHTML = '';
      }

      if (!data.length) {
        // Only show this message if it's the top level and no data was parsed
        if (level === 0) {
          parentElement.innerHTML = '<p class="text-gray-500 italic">Tidak ada data TLV yang dikenali atau format tidak valid.</p>';
        }
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = `mb-1 ${level > 0 ? `ml-${level * 4}` : ''}`; // Indent based on level

        const tagSpan = document.createElement('span');
        tagSpan.className = 'font-semibold text-green-700';
        tagSpan.textContent = `Tag ${item.tag}`;

        const descSpan = document.createElement('span');
        descSpan.className = 'text-red-600 ml-1';
        descSpan.textContent = `(${item.description})`;

        const valueSpan = document.createElement('span');
        valueSpan.className = 'text-gray-800 break-words';
        valueSpan.textContent = `: ${item.value}`;

        div.appendChild(tagSpan);
        div.appendChild(descSpan);
        div.appendChild(valueSpan);
        parentElement.appendChild(div);

        // Recursively display children
        if (item.children && item.children.length > 0) {
          displayParsedContent(item.children, parentElement, level + 1);
        }
      });
    }

    /**
     * Handles the QR code generation and TLV parsing logic.
     */
    async function generateQrCode() {
      const input = qrInput.value.trim();

      // Reset display
      qrCodeImage.classList.add('hidden');
      qrLoadingIndicator.classList.add('hidden');
      placeholderText.classList.remove('hidden');
      parsedContentContainer.classList.add('hidden');
      parsedContentList.innerHTML = ''; // Clear previous parsed content
      downloadOptions.classList.add('hidden'); // Hide download options initially

      if (!input) {
        showMessageBox('Mohon masukkan teks atau URL untuk menghasilkan QR Code.');
        return;
      }

      // Show loading indicator
      qrLoadingIndicator.classList.remove('hidden');
      placeholderText.classList.add('hidden'); // Hide placeholder when loading

      // Get the selected file type for generation
      const selectedFileType = fileTypeSelect.value;

      // Request a larger QR code image from the API, now including format
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(input)}&format=${selectedFileType}`;
      qrCodeImage.src = qrUrl; // Set the src immediately to trigger loading

      // Use a Promise to handle image loading for better feedback
      await new Promise((resolve) => {
        qrCodeImage.onload = () => {
          qrLoadingIndicator.classList.add('hidden');
          qrCodeImage.classList.remove('hidden');
          downloadOptions.classList.remove('hidden'); // Show download options after QR is loaded
          resolve();
        };
        qrCodeImage.onerror = () => {
          qrLoadingIndicator.classList.add('hidden');
          showMessageBox('Gagal memuat QR Code. Pastikan koneksi internet Anda stabil.');
          qrCodeImage.classList.add('hidden'); // Hide broken image icon
          placeholderText.classList.remove('hidden'); // Show placeholder again
          downloadOptions.classList.add('hidden'); // Hide download options on error
          resolve(); // Resolve even on error to continue flow
        };
      });

      // Attempt to parse TLV if the input looks like one (starts with '00' or similar common TLV tags)
      // This is a heuristic, real validation would be more complex.
      if (input.match(/^(00|01|26|51|52|53|54|58|59|60|63)\d{2}.+/)) {
        const parsed = parseTLV(input);
        displayParsedContent(parsed, parsedContentList);
        parsedContentContainer.classList.remove('hidden');
      } else {
        // If it doesn't look like TLV, hide the parsed content section
        parsedContentContainer.classList.add('hidden');
      }
    }

    /**
     * Handles the download of the generated QR code.
     */
    function downloadQrCode() {
      const input = qrInput.value.trim();
      if (!input) {
        showMessageBox('Tidak ada QR Code untuk diunduh. Mohon hasilkan QR Code terlebih dahulu.');
        return;
      }

      const selectedFileType = fileTypeSelect.value;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(input)}&format=${selectedFileType}`; // Use a larger size for download

      // Create a temporary anchor element to trigger the download
      const link = document.createElement('a');
      link.href = qrUrl;
      link.download = `qrcode_${Date.now()}.${selectedFileType}`; // Dynamic filename
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Event Listeners
    generateQrBtn.addEventListener('click', generateQrCode);
    qrInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') generateQrCode();
    });
    downloadQrBtn.addEventListener('click', downloadQrCode); // New event listener for download button

    // Initial state setup
    document.addEventListener('DOMContentLoaded', () => {
      qrCodeImage.classList.add('hidden');
      placeholderText.classList.remove('hidden');
      parsedContentContainer.classList.add('hidden');
      downloadOptions.classList.add('hidden'); // Ensure hidden on load
    });
  </script>
</body>
</html>
